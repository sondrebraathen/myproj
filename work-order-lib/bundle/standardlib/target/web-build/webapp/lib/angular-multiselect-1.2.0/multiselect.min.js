angular.module("am.multiselect",[]).factory("optionParser",["$parse",function(e){var n=/^\s*([\s\S]+?)(?:\s+as\s+([\s\S]+?))?\s+for\s+(?:([\$\w][\$\w\d]*))\s+in\s+([\s\S]+?)$/;return{parse:function(t){var l=t.match(n);if(!l)throw new Error('Expected typeahead specification in form of "_modelValue_ (as _label_)? for _item_ in _collection_" but got "'+t+'".');return{itemName:l[3],source:e(l[4]),viewMapper:e(l[2]||l[1]),modelMapper:e(l[1])}}}}]).directive("amMultiselect",["$parse","$document","$compile","$interpolate","$filter","optionParser",function(e,n,t,l,r,a){return{restrict:"E",require:"ngModel",link:function(n,i,c,u){function o(){b.items.length=0;var e=v.source(n);if(angular.isDefined(e))for(var t=0;t<e.length;t++){var l={};l[v.itemName]=e[t],b.items.push({label:v.viewMapper(l),model:v.modelMapper(l),checked:!1})}}function s(){if(d(u.$modelValue))return b.header=void 0!==c.msHeader?c.msHeader:"Select";if(k)if(c.msSelected)b.header=l(c.msSelected)(b);else if(1==u.$modelValue.length)for(var e=0;e<b.items.length;e++)b.items[e].model===u.$modelValue[0]&&(b.header=b.items[e].label);else b.header=u.$modelValue.length+" selected";else if(angular.isString(u.$modelValue))b.header=u.$modelValue;else{var n={};n[v.itemName]=u.$modelValue,b.header=v.viewMapper(n)||b.items[u.$modelValue].label}}function d(e){if(angular.isNumber(e))return!1;if(e&&e.length&&e.length>0)return!1;for(var n in e)if(e[n])return!1;return!0}function f(e){e.checked?b.uncheckAll():(b.uncheckAll(),e.checked=!e.checked),h(!1)}function m(e){e.checked=!e.checked,h(!0)}function h(e){var n=null;e?(n=[],angular.forEach(b.items,function(e){e.checked&&n.push(e.model)})):angular.forEach(b.items,function(e){return e.checked?(n=e.model,!1):void 0}),u.$setViewValue(n)}function p(e){angular.isArray(e)?angular.forEach(b.items,function(n){n.checked=!1,angular.forEach(e,function(e){angular.equals(n.model,e)&&(n.checked=!0)})}):angular.forEach(b.items,function(n){return angular.equals(n.model,e)?(b.uncheckAll(),n.checked=!0,h(!1),!1):void 0})}var g=u.$isEmpty;u.$isEmpty=function(e){return g(e)||angular.isArray(e)&&0==e.length};var $=c.options,v=a.parse($),k=c.multiple?!0:!1,x=!1,b=n.$new(),w=c.change||angular.noop;b.items=[],b.header="Select",b.multiple=k,b.disabled=!1,b.onBlur=c.ngBlur||angular.noop,n.$on("$destroy",function(){b.$destroy()});var I=angular.element("<am-multiselect-popup"+(c.templateUrl?' template-url="'+c.templateUrl+'"':"")+"></am-multiselect-popup>");(c.required||c.ngRequired)&&(x=!0),c.$observe("required",function(e){x=e}),b.$watch(function(){return e(c.disabled)(n)},function(e){b.disabled=e}),b.$watch(function(){return e(c.multiple)(n)},function(e){k=e||!1}),b.$watch(function(){return v.source(n)},function(e){angular.isDefined(e)&&o()},!0),b.$watch(function(){return u.$modelValue},function(e,n){angular.isDefined(e)&&(p(e),b.$eval(w)),s(),u.$setValidity("required",b.valid())},!0),o(),i.append(t(I)(b)),b.valid=function(){if(!x)return!0;var e=u.$modelValue;return angular.isArray(e)&&e.length>0||!angular.isArray(e)&&null!=e},b.checkAll=function(){if(k){var e=b.searchText&&b.searchText.label.length>0?r("filter")(b.items,b.searchText):b.items;angular.forEach(e,function(e){e.checked=!0}),h(!0)}},b.uncheckAll=function(){var e=b.searchText&&b.searchText.label.length>0?r("filter")(b.items,b.searchText):b.items;angular.forEach(e,function(e){e.checked=!1}),h(!0)},b.select=function(e){k===!1?(f(e),b.toggleSelect()):m(e)}}}}]).directive("amMultiselectPopup",["$document","$filter",function(e,n){return{restrict:"E",scope:!1,replace:!0,templateUrl:function(e,n){return n.templateUrl||"multiselect.tmpl.html"},link:function(t,l,r){function a(n){i(n.target,l.find(n.target.tagName))?t.$parent.$eval(t.onBlur):(l.removeClass("open"),e.unbind("click",a),t.$apply())}t.selectedIndex=null,t.isVisible=!1,t.filteredItems=null,t.toggleSelect=function(){l.hasClass("open")?(l.removeClass("open"),e.unbind("click",a),t.$parent.$eval(t.onBlur)):(l.addClass("open"),e.bind("click",a),t.focus())},t.focus=function(){var e=l.find("input")[0];e&&e.focus()},t.keydown=function(e){var l=n("filter")(t.items,t.searchText),r=e.keyCode||e.which;13===r?l[t.selectedIndex]&&t.select(l[t.selectedIndex]):38===r?t.selectedIndex=null===t.selectedIndex?l.length-1:t.selectedIndex-1:40===r?t.selectedIndex=null===t.selectedIndex?0:t.selectedIndex+1:t.selectedIndex=null,t.selectedIndex<0?t.selectedIndex=l.length-1:t.selectedIndex>l.length-1&&(t.selectedIndex=0)};var i=function(e,n){for(var t=0;t<n.length;t++)if(e==n[t])return!0;return!1}}}}]);